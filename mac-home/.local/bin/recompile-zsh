#!/usr/bin/env zsh
# Recompile zsh-related scripts to .zwc for faster startup
# - Compiles Zim modules, Zim init, your zsh files, and .zcompdump

emulate -L zsh
setopt err_return
setopt extended_glob

# Support a clean option: remove generated .zwc caches
if [[ ${1:-} == clean || ${1:-} == --clean || ${1:-} == -c ]]; then
  autoload -Uz zrecompile
  typeset -a files
  files=(
    "$HOME/.zshrc"
    "$HOME/.config/zsh/zshrc"
    "$HOME/.config/zsh"/*.zsh(N)
    "$HOME/.config/zsh/functions"/*(.N)
    "$HOME/.config/env"/**/*.zsh(N)
    "$HOME/.config/env"/**/*.sh(N)
  )

  typeset -i removed=0 skipped=0
  # Remove per-file .zwc and .zwc.old
  for f in "${files[@]}"; do
    [[ -e $f ]] || continue
    for suf in ".zwc" ".zwc.old"; do
      if [[ -e $f$suf ]]; then
        rm -f -- $f$suf && removed+=1 || skipped+=1
      else
        skipped+=1
      fi
    done
  done

  # Remove compiled Zim init and completion dump
  dump="${ZDOTDIR:-$HOME}/.zcompdump"
  for g in "$HOME/.zim/init.zsh" "$dump"; do
    for suf in ".zwc" ".zwc.old"; do
      if [[ -e $g$suf ]]; then
        rm -f -- $g$suf && removed+=1 || skipped+=1
      else
        skipped+=1
      fi
    done
  done

  # If available, ask zimfw to clean its compiled files (ignore failures)
  if (( $+commands[zimfw] )); then
    zimfw clean -q >/dev/null 2>&1 || true
  fi

  print -r -- "Clean done: removed=$removed skipped=$skipped"
  return 0
fi

# 1) Compile Zim modules (if zimfw is available)
if (( $+commands[zimfw] )); then
  zimfw compile -q
fi

# 2) Compile Zim top-level init (gives noticeable benefit)
if [[ -f "$HOME/.zim/init.zsh" ]]; then
  if [[ ! -f "$HOME/.zim/init.zsh.zwc" || "$HOME/.zim/init.zsh" -nt "$HOME/.zim/init.zsh.zwc" ]]; then
    zcompile "$HOME/.zim/init.zsh"
  fi
fi

# 3) Compile your zsh configs and functions (only when needed)
autoload -Uz zrecompile
typeset -a files
files=(
  "$HOME/.zshrc"
  "$HOME/.config/zsh/zshrc"
  "$HOME/.config/zsh"/*.zsh(N)
  # 编译 functions 目录下的所有普通文件（包含无扩展名的函数文件）
  "$HOME/.config/zsh/functions"/*(.N)
  # 递归编译 env 目录下的所有 .sh 和 .zsh 文件（包含子目录）
  "$HOME/.config/env"/**/*.zsh(N)
  "$HOME/.config/env"/**/*.sh(N)
)

typeset -i compiled=0 skipped=0
for f in "${files[@]}"; do
  [[ -e "$f" ]] || continue
  if [[ ! -e "$f.zwc" || "$f" -nt "$f.zwc" ]]; then
    zrecompile -pq -- "$f" && compiled+=1
  else
    skipped+=1
  fi
done

# 4) Compile completion dump (after compinit has run at least once)
dump="${ZDOTDIR:-$HOME}/.zcompdump"
if [[ -f "$dump" ]]; then
  if [[ ! -f "$dump.zwc" || "$dump" -nt "$dump.zwc" ]]; then
    zcompile "$dump"
  fi
fi

print -r -- "Recompile done: compiled=$compiled skipped=$skipped"
