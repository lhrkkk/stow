#!/usr/bin/env zsh
set -eo pipefail

# 切换到专用目录
cd "$HOME/.config/claude-morning"

# 设置长期认证 token
export CLAUDE_CODE_OAUTH_TOKEN="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"

# 日志
LOG_DIR="$HOME/Library/Logs"
LOG_FILE="$LOG_DIR/claude-morning.log"
mkdir -p "$LOG_DIR"

# 小工具
timestamp() { date -Iseconds; }
log() { printf '[%s] %s\n' "$(timestamp)" "$*" >> "$LOG_FILE"; }

# 配置：消息与模型（CLAUDE_MODEL 可选），默认消息“你好”。
MESSAGE="${CLAUDE_MESSAGE:-hello}"
MODEL="${CLAUDE_MODEL:-}"

# 通过 Claude Code CLI 非交互发送，避免 TTY 依赖；优先使用 PATH 中的 claude。
if ! command -v claude >/dev/null 2>&1; then
  # 尝试 mise shims 路径
  if [ -d "$HOME/.local/share/mise/shims" ]; then
    export PATH="$HOME/.local/share/mise/shims:$PATH"
    # eval "$(mise hook-env -q)"

  # 尝试 Homebrew 默认路径
  elif [ -x "/opt/homebrew/bin/claude" ]; then
    export PATH="/opt/homebrew/bin:$PATH"
  else
    log "ERROR: 未找到 claude CLI，请先安装并登录（claude install / claude setup-token）。"
    exit 1
  fi
fi

# 组装可选参数
CLAUDE_ARGS=(--dangerously-skip-permissions)
if [ -n "$MODEL" ]; then
  CLAUDE_ARGS+=(--model "$MODEL")
fi
# 如需固定会话，可提前导出 CLAUDE_SESSION_ID（必须是有效 UUID）
if [ -n "${CLAUDE_SESSION_ID:-}" ]; then
  CLAUDE_ARGS+=(--session-id "$CLAUDE_SESSION_ID")
fi
log "CLAUDE_CODE_OAUTH_TOKEN $CLAUDE_CODE_OAUTH_TOKEN"
# 发送并记录结果（--print 为非交互模式）
FULL_CMD="claude --print --output-format text ${CLAUDE_ARGS[*]} \"$MESSAGE\""
log "DEBUG: 执行命令: $FULL_CMD"
log "DEBUG: CLAUDE_CODE_OAUTH_TOKEN 环境变量: ${CLAUDE_CODE_OAUTH_TOKEN:+已设置}"
# claude --print --output-format text "${CLAUDE_ARGS[@]}" "$MESSAGE" 2>&1

set +e
output=$(export CLAUDE_CODE_OAUTH_TOKEN=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 && claude --print --output-format text "${CLAUDE_ARGS[@]}" "$MESSAGE" 2>&1)
rc=$?
set -e
if [ "$rc" -eq 0 ]; then
  log "OK: 已用 Claude Code 发送「$MESSAGE"${MODEL:+ (model=$MODEL)}"."
  exit 0
else
  log "ERROR: claude CLI 返回码 $rc，发送失败：$output"
  exit "$rc"
fi

